<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">js/RTCEngine.js | rtc-engine</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="WebRTC&#xB97C; &#xC774;&#xC6A9;&#xD55C; &#xB370;&#xC774;&#xD130; &#xC804;&#xC1A1;&#xC744; &#xC704;&#xD55C; &#xB77C;&#xC774;&#xBE0C;&#xB7EC;&#xB9AC;"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="rtc-engine"><meta property="twitter:description" content="WebRTC&#xB97C; &#xC774;&#xC6A9;&#xD55C; &#xB370;&#xC774;&#xD130; &#xC804;&#xC1A1;&#xC744; &#xC704;&#xD55C; &#xB77C;&#xC774;&#xBE0C;&#xB7EC;&#xB9AC;"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Quasar-Kim/rtc-engine"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Channel.js~Channel.html">Channel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/ChunkProducer.js~ChunkProducer.html">ChunkProducer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RTCEngine.js~RTCEngine.html">RTCEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/RTCSocket.js~RTCSocket.html">RTCSocket</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/ReadableTransaction.js~ReadableTransaction.html">ReadableTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/Transaction.js~Transaction.html">Transaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/WritableTransaction.js~WritableTransaction.html">WritableTransaction</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#signaler">signaler</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/signaler/Base.js~SignalerBase.html">SignalerBase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/signaler/LocalSignaler.js~LocalSignaler.html">LocalSignaler</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#util">util</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/ListenerManager.js~ListenerManager.html">ListenerManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/Mitt.js~Mitt.html">Mitt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/ObservableEntry.js~ObservableEntry.html">ObservableEntry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/ObservableEntry.js~WaitEntry.html">WaitEntry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/ObservableMap.js~ObservableMap.html">ObservableMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/ObservableQueue.js~ObservableQueue.html">ObservableQueue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/Queue.js~Queue.html">Queue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-observe">observe</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-wait">wait</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-waitAll">waitAll</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makeEta">makeEta</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-once">once</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-prettyBytes">prettyBytes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventListenerEntry">EventListenerEntry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-EventHandler">EventHandler</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/RTCEngine.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import RTCSocket from &apos;./RTCSocket.js&apos;
import once from &apos;./util/once.js&apos;
import Channel from &apos;./Channel.js&apos;
import WritableTransaction from &apos;./WritableTransaction.js&apos;
import ReadableTransaction from &apos;./ReadableTransaction.js&apos;
import ObservableMap from &apos;./util/ObservableMap.js&apos;
import ListenerManager from &apos;./util/ListenerManager.js&apos;
import ObservableQueue from &apos;./util/ObservableQueue.js&apos;
import Mitt from &apos;./util/Mitt.js&apos;
import { ObservableEntry, wait, observe } from &apos;./util/ObservableEntry.js&apos;

const UNNEGOTIATED_SOCKET_PREFIX = &apos;RTCEngine-unnegotiated-socket&apos;
const UNNEGOTIATED_TRANSACTION_PREFIX = &apos;RTCEngine-unnegotiated-transaction&apos;

/**
 * RTC &#xC5F0;&#xACB0;&#xC744; &#xAD00;&#xB9AC;&#xD558;&#xB294; &#xC5D4;&#xC9C4;.
 */
export default class RTCEngine extends Mitt {
  /**
   * RTCEngine&#xC744; &#xC0DD;&#xC131;&#xD569;&#xB2C8;&#xB2E4;. autoConnect &#xC635;&#xC158;&#xC774; true&#xC77C;&#xACBD;&#xC6B0;(&#xAE30;&#xBCF8;&#xAC12;) &#xC790;&#xB3D9;&#xC73C;&#xB85C; &#xC5F0;&#xACB0;&#xC744; &#xC2DC;&#xC791;&#xD569;&#xB2C8;&#xB2E4;.
   * @param {*} signaler &#xBA54;&#xC2DC;&#xC9C0; &#xC1A1;&#xC218;&#xC2E0;&#xC5D0; &#xC0AC;&#xC6A9;&#xD560; &#xC2DC;&#xADF8;&#xB110;&#xB7EC;.
   * @param {object} userOptions
   * @param {boolean} [userOptions.autoConnect] RTCEngine &#xC0DD;&#xC131;&#xC2DC; &#xC790;&#xB3D9; &#xC5F0;&#xACB0; &#xC5EC;&#xBD80;&#xB97C; &#xACB0;&#xC815;&#xD558;&#xB294; &#xC635;&#xC158;.
   * @param {RTCIceServer[]} [userOptions.iceServers] &#xC5F0;&#xACB0;&#xC5D0; &#xC0AC;&#xC6A9;&#xD560; ICE &#xC11C;&#xBC84;&#xB4E4;.
   * @param {&apos;polite&apos;|&apos;impolite&apos;} [userOptions.role] &#xC5F0;&#xACB0;&#xC5D0;&#xC11C; &#xC774; &#xD53C;&#xC5B4;&#xC758; &#xC5ED;&#xD560;&#xC744; &#xC218;&#xB3D9;&#xC73C;&#xB85C; &#xC124;&#xC815;&#xD568;.
   * @param {boolean} [userOptions.waitOnlineOnReconnection] &#xC7AC;&#xC5F0;&#xACB0;&#xC2DC; &#xC778;&#xD130;&#xB137;&#xC774; &#xC5F0;&#xACB0;&#xB420;&#xB54C;&#xAE4C;&#xC9C0; &#xB300;&#xAE30;&#xD588;&#xB2E4;&#xAC00; &#xC5F0;&#xACB0;&#xD568;.
   */
  constructor (signaler, userOptions = {}) {
    super()

    // &#xC635;&#xC158; &#xD569;&#xCE58;&#xAE30;
    const signalerOptions = signaler.options
    this.options = {
      autoConnect: true,
      iceServers: [
        { urls: [&apos;stun:stun.l.google.com:19302&apos;] }
      ],
      waitOnlineOnReconnection: true,
      ...signalerOptions,
      ...userOptions
    }

    console.log(&apos;[RTCEngine]&apos;, &apos;&#xC0AC;&#xC6A9;&#xD560; &#xC635;&#xC158;:&apos;, this.options)

    // role &#xC124;&#xC815;
    // &#xB9CC;&#xC57D; options.role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xC9C0; &#xC54A;&#xB2E4;&#xBA74; &#xB098;&#xC911;&#xC5D0; start() &#xD638;&#xCD9C; &#xC2DC; assignRole()&#xC744; &#xC774;&#xC6A9;&#xD574; &#xC790;&#xB3D9;&#xC73C;&#xB85C; role&#xC744; &#xC124;&#xC815;&#xD568;
    if (this.options.role) {
      if (![&apos;polite&apos;, &apos;impolite&apos;].includes(this.options.role)) {
        throw new Error(`config.role&#xC774; &#xC798;&#xBABB; &#xC124;&#xC815;&#xB418;&#xC5C8;&#xC2B5;&#xB2C8;&#xB2E4;. &#xD604;&#xC7AC; &#xC124;&#xC815;&#xC740; &apos;${this.options.role}&apos;&#xC785;&#xB2C8;&#xB2E4;. &#xC62C;&#xBC14;&#xB978; &#xAC12;&#xC740; &apos;polite&apos; &#xB610;&#xB294; &apos;impolite&apos;&#xC785;&#xB2C8;&#xB2E4;.`)
      }
    }

    // &#xB0B4;&#xBD80; property &#xC124;&#xC815;

    /**
     * perfect negotiation pattern&#xC5D0;&#xC11C; &#xC0AC;&#xC6A9;&#xD558;&#xB294; role
     */
    this.polite = new ObservableEntry(this.options.role ? this.options.role === &apos;polite&apos; : undefined)

    /**
     * &#xD53C;&#xC5B4; &#xCEE4;&#xB125;&#xC158; &#xAC1D;&#xCCB4;
     */
    this.pc = new RTCPeerConnection({
      iceServers: this.options.iceServers
    })

    /**
     * &#xC0C1;&#xB300;&#xBC29;&#xC774; socket()&#xC744; &#xB808;&#xC774;&#xBE14;&#xACFC; &#xD568;&#xAED8; &#xD638;&#xCD9C;&#xD55C; &#xACB0;&#xACFC; &#xC774;&#xCABD;&#xC5D0;&#xC11C; &#xBC1B;&#xC740; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xB4E4;.
     * &#xD0A4;: &#xB808;&#xC774;&#xBE14;
     * &#xAC12;: &#xC18C;&#xCF13;&#xC774; &#xC0AC;&#xC6A9;&#xD560; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;(RTCDataChannel)
     */
    this.negotiatedDataChannels = new ObservableMap()

    /**
     * &#xC0C1;&#xB300;&#xBC29;&#xC774; socket()&#xC744; &#xB808;&#xC774;&#xBE14; &#xC5C6;&#xC774; &#xD638;&#xCD9C;&#xD55C; &#xACB0;&#xACFC; &#xC774;&#xCABD;&#xC5D0;&#xC11C; &#xBC1B;&#xC740; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xB4E4;.
     */
    this.unnegotiatedDataChannels = new ObservableQueue()

    /**
     * &#xC0C1;&#xB300;&#xBC29;&#xC774; writable()&#xC744; &#xB808;&#xC774;&#xBE14; &#xC5C6;&#xC774; &#xD638;&#xCD9C;&#xD55C; &#xACB0;&#xACFC; &#xC774;&#xCABD;&#xC5D0;&#xC11C; &#xBC1B;&#xC740; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xB4E4;
     */
    this.unnegotiatedTransactions = new ObservableQueue()

    /**
     * offer collision &#xBC29;&#xC9C0;&#xB97C; &#xC704;&#xD574; offer&#xC744; &#xB9CC;&#xB4DC;&#xB294; &#xB3D9;&#xC548;&#xC774;&#xBA74; &#xAE30;&#xB85D;
     */
    this.makingOffer = false

    /**
     * offer collision &#xBC29;&#xC9C0;&#xB97C; &#xC704;&#xD574; role&#xC774;&#xB098; signalingState&#xB4F1;&#xC5D0; &#xAE30;&#xBC18;&#xD574; &#xBC1B;&#xC740; offer&#xC744; &#xBC1B;&#xC744;&#xC9C0; &#xACB0;&#xC815;
     */
    this.ignoreOffer = false

    /**
     * &#xC5F0;&#xACB0;&#xC758; &#xC0C1;&#xD0DC;&#xB97C; &#xB098;&#xD0C0;&#xB0C4;. inactive, closed&#xB97C; &#xC81C;&#xC678;&#xD558;&#xACE0;&#xB294; RTCPeerConnection&#xC758; connectionState&#xC640; &#xB3D9;&#xC77C;&#xD568;.
     * @type {ObservableEntry&lt;&apos;inactive&apos;|&apos;connecting&apos;|&apos;connected&apos;|&apos;disconnected&apos;|&apos;failed&apos;|&apos;closed&apos;&gt;}
     */
    this.connection = new ObservableEntry(&apos;inactive&apos;)

    /**
     * &#xC678;&#xBD80; API&#xC5D0; &#xAC74; &#xC774;&#xBCA4;&#xD2B8; &#xB9AC;&#xC2A4;&#xB108;&#xB4E4;&#xC744; &#xAD00;&#xB9AC;&#xD558;&#xB294; &#xAC1D;&#xCCB4;
     */
    this.listenerManager = new ListenerManager()

    /**
     * &#xBA54;&#xC2DC;&#xC9C0;&#xB97C; &#xC804;&#xB2EC;&#xD558;&#xB294;&#xB370; &#xC0AC;&#xC6A9;&#xB418;&#xB294; &#xC2DC;&#xADF8;&#xB110;&#xB7EC;
     */
    this.signaler = signaler

    /**
     * role &#xBC30;&#xC815;&#xC744; &#xC704;&#xD55C; &#xB09C;&#xC218;
     */
    this.seed = Math.random()

    /**
     * &#xC5F0;&#xACB0;&#xC774; &#xB2EB;&#xD614;&#xB294;&#xC9C0; &#xB098;&#xD0C0;&#xB0B4;&#xB294; &#xC18D;&#xC131;
     */
    this.closed = new ObservableEntry(false)

    /**
     * &#xC774;&#xB54C;&#xAE4C;&#xC9C0; &#xC0DD;&#xC131;&#xB41C; unnegotiated socket&#xC758; &#xAC1C;&#xC218;.
     * unnegotiated socket &#xC0DD;&#xC131;&#xC2DC; &#xB808;&#xC774;&#xBE14;&#xC744; &#xB9CC;&#xB4E4; &#xB54C; &#xC0AC;&#xC6A9;&#xB429;&#xB2C8;&#xB2E4;. (&#xC608;&#xC2DC;: RTCEngine-unnegotiated-socket_0)
     */
    this.unnegotiatedSocketCount = 0

    /**
     * &#xC774;&#xB54C;&#xAE4C;&#xC9C0; &#xC0DD;&#xC131;&#xB41C; unnegotiated transaction&#xC758; &#xAC1C;&#xC218;.
     */
    this.unnegotiatedTransactionCount = 0

    // &#xC790;&#xB3D9; &#xC5F0;&#xACB0;
    if (this.options.autoConnect) {
      this.connect()
    }
  }

  /**
   * &#xBB34;&#xC791;&#xC704;&#xB85C; &#xB450; &#xD53C;&#xC5B4;&#xC758; &#xC5ED;&#xD560;&#xC744; &#xC815;&#xD569;&#xB2C8;&#xB2E4;. &#xC5EC;&#xAE30;&#xC11C; &#xC5ED;&#xD560;&#xC740; Perfect Negotiation Pattern&#xC5D0;&#xC11C; &#xC0AC;&#xC639;&#xB418;&#xB294; polite/impolite &#xD53C;&#xC5B4;&#xB97C; &#xC758;&#xBBF8;&#xD569;&#xB2C8;&#xB2E4;.
   * @private
   * @returns {Promise&lt;void&gt;} &#xC5ED;&#xD560; &#xBC30;&#xC815;&#xC774; &#xB05D;&#xB098;&#xBA74; resolve&#xB418;&#xB294; promise
   */
  assignRole () {
    // role &#xC124;&#xC815; &#xC2DC;&#xB098;&#xB9AC;&#xC624;
    // 1. &#xCC98;&#xC74C; &#xC5F0;&#xACB0;&#xD560;&#xB54C;: &#xC11C;&#xB85C; &#xC790;&#xC2E0;&#xC758; &#xC2DC;&#xB4DC;&#xB97C; &#xBCF4;&#xB0B4;&#xACE0; &#xC0C1;&#xB300;&#xC758; &#xC2DC;&#xB4DC;&#xB97C; &#xBC1B;&#xC544; &#xAC01;&#xC790;&#xC758; role&#xC744; &#xC124;&#xC815;&#xD568;.
    // 2. &#xC7AC;&#xC5F0;&#xACB0; &#xC2DC; &#xD55C;&#xCABD;(B)&#xC774; &#xC0C8;&#xB85C;&#xACE0;&#xCE68; &#xB41C; &#xACBD;&#xC6B0;: B&#xC5D0;&#xC11C; &#xC2DC;&#xB4DC;&#xB97C; &#xBCF4;&#xB0B4;&#xBA74; A&#xB294; &#xC790;&#xC2E0;&#xC758; role&#xC744; &#xCD08;&#xAE30;&#xD654;&#xD558;&#xACE0; &#xC790;&#xC2E0;&#xC758; &#xC2DC;&#xB4DC;&#xB97C; &#xBCF4;&#xB0C4;.
    // &#xC5B4;&#xB5A4; &#xACBD;&#xC6B0;&#xC774;&#xB4E0;&#xC9C0; &#xC11C;&#xB85C; &#xC2DC;&#xB4DC;&#xB97C; &#xAD50;&#xD658;&#xD558;&#xAC8C; &#xB428;.
    return new Promise(resolve =&gt; {
      const sendRoleSeed = async () =&gt; {
        await this.sendSignal({
          type: &apos;role&apos;,
          seed: this.seed
        })
      }

      this.signaler.on(&apos;role&apos;, async msg =&gt; {
        const remoteSeed = msg.seed

        // role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xB294; &#xACBD;&#xC6B0;
        if (this.polite.get() !== undefined) {
          this.polite.set(undefined)
          await sendRoleSeed()
        }

        // role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xC9C0; &#xC54A;&#xC740; &#xACBD;&#xC6B0;
        if (remoteSeed === this.seed) {
          // &#xC2DC;&#xB4DC; &#xCDA9;&#xB3CC; &#xBC1C;&#xC0DD;&#xC2DC; &#xC790;&#xC2E0;&#xC758; &#xC2DC;&#xB4DC;&#xB97C; &#xBC14;&#xAFD4;&#xC11C; &#xC804;&#xC1A1;
          this.seed = Math.random()
          await sendRoleSeed()
        } else if (remoteSeed &gt; this.seed) {
          this.polite.set(true)
          resolve()
        } else {
          this.polite.set(false)
          resolve()
        }
      })

      // &#xC5EC;&#xAE34; await&#xD560; &#xC774;&#xC720;&#xAC00; &#xB531;&#xD788; &#xC5C6;&#xC74C;
      sendRoleSeed()
    })
  }

  /**
   * &#xC5D4;&#xC9C4;&#xC744; &#xC2DC;&#xC791;&#xD569;&#xB2C8;&#xB2E4;. &#xC2DC;&#xC791;&#xC2DC; Perfect Negotiation Pattern&#xC744; &#xC774;&#xC6A9;&#xD574; &#xC0C1;&#xB300;&#xBC29;&#xACFC; RTC&#xB97C; &#xD615;&#xC131; &#xBC0F; &#xAD00;&#xB9AC;&#xD569;&#xB2C8;&#xB2E4;.
   * &#xC5F0;&#xACB0;&#xC774; &#xB04A;&#xC5B4;&#xC9C8; &#xACBD;&#xC6B0; &#xC778;&#xD130;&#xB137;&#xC774; &#xB2E4;&#xC2DC; &#xC5F0;&#xACB0;&#xB420;&#xB54C;&#xAE4C;&#xC9C0; &#xB300;&#xAE30;&#xD588;&#xB2E4;&#xAC00; ice restart&#xB97C; &#xC2DC;&#xB3C4;&#xD569;&#xB2C8;&#xB2E4;. &#xC774;&#xB54C; &#xBA54;&#xC2DC;&#xC9C0;&#xAC00; &#xC131;&#xACF5;&#xC801;&#xC73C;&#xB85C; &#xAD50;&#xD658;&#xB41C;&#xB2E4;&#xBA74; &#xC5F0;&#xACB0;&#xC774; &#xB2E4;&#xC2DC; &#xD615;&#xC131;&#xB429;&#xB2C8;&#xB2E4;.
   */
  async start () {
    // 1. &#xC774;&#xBCA4;&#xD2B8; &#xD578;&#xB4E4;&#xB7EC; &#xC124;&#xCE58;
    // &#xC544;&#xB798; &#xB0B4;&#xBD80; &#xD568;&#xC218;&#xB4E4;&#xC740; &#xBAA8;&#xB450; this&#xB85C; RTCEngine &#xC778;&#xC2A4;&#xD134;&#xC2A4;&#xC5D0; &#xC811;&#xADFC;&#xD560; &#xC218; &#xC788;&#xAC8C; &#xD558;&#xAE30; &#xC704;&#xD574;
    // &#xBAA8;&#xB450; &#xD654;&#xC0B4;&#xD45C; &#xD568;&#xC218;&#xC784;

    // role &#xBA54;&#xC2DC;&#xC9C0;&#xB97C; &#xBC1B;&#xC740; &#xACBD;&#xC6B0;
    // role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xC9C0; &#xC54A;&#xC73C;&#xBA74;: &#xC591;&#xCABD; &#xB2E4; role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xC9C0; &#xC54A;&#xB2E4;&#xB294; &#xAC78; &#xC758;&#xBBF8;. &#xC989; &#xB458;&#xB2E4; &#xC7AC;&#xC5F0;&#xACB0;&#xC774; &#xC544;&#xB2CC; &#xCC98;&#xC74C;&#xC73C;&#xB85C; &#xC5F0;&#xACB0;&#xD558;&#xB294; &#xAC83;.
    //   &#xC774; &#xACBD;&#xC6B0; start() &#xD638;&#xCD9C; &#xC2DC; role &#xC124;&#xC815; &#xBA54;&#xC2DC;&#xC9C0;&#xAC00; &#xC544;&#xB798;&#xC5D0;&#xC11C; &#xBCF4;&#xB0B4;&#xC9C8; &#xAC83;&#xC774;&#xBBC0;&#xB85C; &#xB2F5;&#xC7A5;&#xD560; &#xD544;&#xC694; &#xC5C6;&#xC74C;.
    // role&#xC774; &#xC124;&#xC815;&#xB418;&#xC5B4; &#xC788;&#xB294; &#xACBD;&#xC6B0;: &#xB458; &#xC911; &#xD55C;&#xCABD;&#xC774; &#xC0C8;&#xB85C;&#xACE0;&#xCE68; &#xB41C; &#xACBD;&#xC6B0; &#xBC1C;&#xC0DD;&#xD560; &#xC218; &#xC788;&#xC74C;. &#xC774; &#xACBD;&#xC6B0;&#xC5D0;&#xB294; &#xB2F5;&#xC7A5;&#xC744; &#xBCF4;&#xB0B4;&#xC11C;
    //   role&#xC744; &#xC7AC;&#xC124;&#xC815;&#xD574;&#xC57C; &#xD568;
    const sendLocalDescription = async () =&gt; {
      try {
        this.makingOffer = true
        await this.pc.setLocalDescription()
        console.groupCollapsed(&apos;creating offer&apos;)
        await this.sendSignal({
          type: &apos;description&apos;,
          description: this.pc.localDescription
        })
        console.groupEnd()
      } finally {
        this.makingOffer = false
      }
    }

    const sendIceCandidate = async rtcIceCandidate =&gt; {
      console.groupCollapsed(&apos;sending ice candidate&apos;)
      await this.sendSignal({
        type: &apos;icecandidate&apos;,
        candidate: rtcIceCandidate.candidate
      })
      console.groupEnd(&apos;sending ice candidate&apos;)
    }

    const setDescription = async description =&gt; {
      console.log(&apos;[RTCEngine]&apos;, &apos;description &#xBC1B;&#xC74C;&apos;, description)
      const makingOffer = this.makingOffer
      const offerCollision = description.type === &apos;offer&apos; &amp;&amp; (makingOffer || this.pc.signalingState !== &apos;stable&apos;)
      this.ignoreOffer = !this.polite.get() &amp;&amp; offerCollision

      if (offerCollision) {
        console.groupCollapsed(&apos;offer collision &#xBC1C;&#xC0DD;&#xD568;&apos;)
        console.log(&apos;[RTCEngine]&apos;, &apos;makingOffer:&apos;, makingOffer)
        console.log(&apos;[RTCEngine]&apos;, &apos;signaling state:&apos;, this.pc.signalingState)
      }

      if (this.ignoreOffer) {
        console.log(&apos;[RTCEngine]&apos;, &apos;&#xC0C1;&#xB300;&#xC758; offer&#xB97C; &#xBB34;&#xC2DC;&#xD568;&apos;)
        console.groupEnd()
        return
      }

      console.log(&apos;[RTCEngine]&apos;, &apos;&#xC0C1;&#xB300;&#xC758; offer&#xB97C; &#xBC1B;&#xC74C;&apos;)
      console.groupEnd()

      await this.pc.setRemoteDescription(description)
      if (description.type === &apos;offer&apos;) {
        await this.pc.setLocalDescription()
        console.groupCollapsed(&apos;making answer&apos;)
        await this.sendSignal({
          type: &apos;description&apos;,
          description: this.pc.localDescription
        })
        console.groupEnd()
      }
    }

    const setIceCandidate = async candidate =&gt; {
      try {
        console.log(&apos;[RTCEngine]&apos;, &apos;ice candidate &#xBC1B;&#xC74C;&apos;, candidate)
        await this.pc.addIceCandidate(candidate)
      } catch (err) {
        if (!this.ignoreOffer) {
          throw err
        }
      }
    }

    const updateConnectionState = () =&gt; {
      console.log(&apos;[RTCEngine]&apos;, &apos;connection state:&apos;, this.pc.connectionState)
      this.connection.set(this.pc.connectionState)
    }

    const saveDataChannels = ({ channel: dataChannel }) =&gt; {
      if (dataChannel.label.startsWith(UNNEGOTIATED_SOCKET_PREFIX)) {
        this.unnegotiatedSocketCount++
        this.unnegotiatedDataChannels.push(dataChannel)
      } else if (dataChannel.label.startsWith(UNNEGOTIATED_TRANSACTION_PREFIX)) {
        this.unnegotiatedTransactionCount++
        this.unnegotiatedTransactions.push(dataChannel)
      } else {
        this.negotiatedDataChannels.set(dataChannel.label, dataChannel)
      }
    }

    const logIceConnectionStateChange = () =&gt; {
      console.log(&apos;[RTCEngine]&apos;, &apos;ice connection state:&apos;, this.pc.iceConnectionState)
    }

    this.listenerManager.add(this.pc, &apos;negotiationneeded&apos;, sendLocalDescription)
    this.listenerManager.add(this.pc, &apos;icecandidate&apos;, sendIceCandidate)
    this.listenerManager.add(this.pc, &apos;connectionstatechange&apos;, updateConnectionState)
    this.listenerManager.add(this.pc, &apos;iceconnectionstatechange&apos;, logIceConnectionStateChange)
    this.listenerManager.add(this.pc, &apos;datachannel&apos;, saveDataChannels)

    this.signaler.on(&apos;description&apos;, msg =&gt; setDescription(msg.description))
    this.signaler.on(&apos;icecandidate&apos;, msg =&gt; setIceCandidate(msg.candidate))

    // 2. &#xC5F0;&#xACB0; &#xC2DC;&#xC791;
    // &#xC2DC;&#xADF8;&#xB110;&#xB7EC; start() &#xD6C5; &#xD638;&#xCD9C;
    await this.signaler.start()

    // &#xC2DC;&#xADF8;&#xB110;&#xB7EC; &#xD6C5; &#xC608;&#xC57D;
    observe(this.connection).toBe(&apos;connected&apos;).then(() =&gt; this.signaler.connected())
    observe(this.connection).toBe(&apos;disconnected&apos;).then(() =&gt; this.signaler.disconnected())
    observe(this.connection).toBe(&apos;failed&apos;).then(() =&gt; this.signaler.failed())

    // &#xBA3C;&#xC800; role &#xC124;&#xC815;&#xD558;&#xAE30;
    if (this.polite.get() === undefined) {
      await this.assignRole()
      console.log(&apos;[RTCEngine]&apos;, &apos;polite&apos;, this.polite.get())
    }

    // &#xC18C;&#xCF13; &#xB9CC;&#xB4E4;&#xBA74; &#xC5F0;&#xACB0; &#xC2DC;&#xC791;
    this.socket(&apos;RTCEngine-internal&apos;).then(socket =&gt; {
      // &#xC5F0;&#xACB0;&#xC774; &#xB2EB;&#xD788;&#xBA74; &#xC5EC;&#xAE30;&#xC11C; &#xB9AC;&#xC18C;&#xC2A4; &#xC815;&#xB9AC;
      socket.dataChannel.addEventListener(&apos;close&apos;, () =&gt; {
        if (this.closed.get()) return
        this.close()
      }, { once: true })
    })

    // 3. &#xC7AC;&#xC5F0;&#xACB0;
    // connection&#xC774; failed&#xC774;&#xACE0;, &#xC778;&#xD130;&#xB137;&#xC5D0; &#xC5F0;&#xACB0;&#xB418;&#xC5B4; &#xC788;&#xACE0;, &#xC2DC;&#xADF8;&#xB110;&#xB7EC;&#xAC00; &#xC900;&#xBE44;&#xB418;&#xC5B4; &#xC788;&#xC744; &#xB54C; ice restart&#xB97C; &#xC2DC;&#xB3C4;&#xD568;
    observe(this.connection).onChange(() =&gt; {
      if (this.connection.get() !== &apos;failed&apos;) return

      const reconnect = async () =&gt; {
        console.log(&apos;[RTCEngine]&apos;, &apos;&#xC2DC;&#xADF8;&#xB110;&#xB7EC; ready &#xB300;&#xAE30;&#xC911;&apos;)
        await wait(this.signaler.ready).toBe(true)

        // wait&#xD558;&#xB294; &#xC911; close()&#xAC00; &#xD638;&#xCD9C;&#xB418;&#xC5C8;&#xC744;&#xC218;&#xB3C4; &#xC788;&#xC74C;
        if (this.closed.get()) return

        this.restartIce()
        console.log(&apos;[RTCEngine]&apos;, &apos;&#xC7AC;&#xC5F0;&#xACB0; &#xC2DC;&#xB3C4;&#xD558;&#xB294; &#xC911;...&apos;)
      }

      if (navigator.onLine || !this.options.waitOnlineOnReconnection) {
        reconnect()
      } else {
        console.log(&apos;[RTCEngine]&apos;, &apos;&#xC624;&#xD504;&#xB77C;&#xC778; &#xC0C1;&#xD0DC;, &#xC778;&#xD130;&#xB137; &#xC5F0;&#xACB0; &#xB300;&#xAE30; &#xC911;&apos;)
        this.listenerManager.add(window, &apos;online&apos;, reconnect, { once: true })
      }
    })
  }

  /**
   * &#xC5F0;&#xACB0;&#xC744; &#xC2DC;&#xC791;&#xD558;&#xACE0;, &#xC5F0;&#xACB0;&#xC774; &#xC131;&#xACF5;&#xD560;&#xB54C;&#xAE4C;&#xC9C0; &#xAE30;&#xB2E4;&#xB9BD;&#xB2C8;&#xB2E4;.
   * &#xB610; navigator.onLine&#xC774; false&#xC778; &#xC0C1;&#xD0DC;&#xC5D0;&#xC11C; &#xC218;&#xB3D9;&#xC73C;&#xB85C; &#xC7AC;&#xC5F0;&#xACB0;&#xC744; &#xC2DC;&#xB3C4;&#xD558;&#xAE30; &#xC704;&#xD574;&#xC11C;&#xB3C4; &#xC0AC;&#xC6A9;&#xB429;&#xB2C8;&#xB2E4;.
   * @returns {Promise&lt;void&gt;} &#xC5F0;&#xACB0;&#xC774; &#xC131;&#xACF5;&#xD558;&#xBA74; resolve&#xD558;&#xB294; promise
   */
  async connect () {
    if (this.connection.get() === &apos;failed&apos;) {
      this.restartIce()
    } else if (this.connection.get() === &apos;inactive&apos;) {
      this.start()
    }

    return wait(this.connection).toBe(&apos;connected&apos;)
  }

  /**
   * &#xC591;&#xCABD; &#xD53C;&#xC5B4;&#xC5D0;&#xC11C; &#xC0AC;&#xC6A9; &#xAC00;&#xB2A5;&#xD55C; RTCSocket&#xC744; &#xC5FD;&#xB2C8;&#xB2E4;. &#xC591;&#xCABD; &#xD53C;&#xC5B4; &#xBAA8;&#xB450; &#xB3D9;&#xC77C;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;&#xB85C; &#xC774; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xD638;&#xCD9C;&#xD558;&#xBA74; RTCSocket&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9D1;&#xB2C8;&#xB2E4;.
   * @param {string|undefined} [label] &#xC18C;&#xCF13;&#xC744; &#xC2DD;&#xBCC4;&#xD558;&#xAE30; &#xC704;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;. __&#xC911;&#xBCF5;&#xC774; &#xBD88;&#xAC00;&#xB2A5;&#xD569;&#xB2C8;&#xB2E4;.__ &#xBE44;&#xC6CC;&#xB450;&#xBA74; unnegotiated socket&#xC744; &#xC0DD;&#xC131;&#xD569;&#xB2C8;&#xB2E4;.
   * @returns {Promise&lt;RTCSocket&gt;} RTCSocket&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9C0;&#xBA74; &#xADF8;&#xAC78; resolve&#xD558;&#xB294; promise
   */
  async socket (label = undefined) {
    // &#xB808;&#xC774;&#xBE14;&#xC774; &#xC788;&#xC73C;&#xBA74; negotiated socket &#xC0DD;&#xC131;
    if (typeof label === &apos;string&apos;) {
      return this.createNegotiatedSocket(label)
    }

    // label&#xC774; &#xC5C6;&#xC73C;&#xBA74; unnegotiated socket &#xC0DD;&#xC131;
    return this.createUnnegotiatedSocket()
  }

  /**
   * &#xB808;&#xC774;&#xBE14; &#xC5C6;&#xC774; &#xB3D9;&#xC801;&#xC73C;&#xB85C; &#xC18C;&#xCF13;&#xC744; &#xC0DD;&#xC131;&#xD569;&#xB2C8;&#xB2E4;.
   * @private
   * @param {string|undefined} [labelOverride] &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xC758; &#xB808;&#xC774;&#xBE14;. &#xC2DD;&#xBCC4;&#xC790;&#xB85C; &#xC0AC;&#xC6A9;&#xB418;&#xC9C0; &#xC54A;&#xACE0; &#xC911;&#xBCF5;&#xC774; &#xAC00;&#xB2A5;&#xD569;&#xB2C8;&#xB2E4;. &#xC774; &#xD30C;&#xB77C;&#xBBF8;&#xD130;&#xAC00; `undefined`&#xBA74; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xC758; &#xB808;&#xC774;&#xBE14;&#xC740; &#xAE30;&#xBCF8;&#xAC12;&#xC73C;&#xB85C; &#xC124;&#xC815;&#xB429;&#xB2C8;&#xB2E4;.
   * @returns {Promise&lt;RTCSocket&gt;}
   */
  async createUnnegotiatedSocket (labelOverride = undefined) {
    const label = labelOverride || `${UNNEGOTIATED_SOCKET_PREFIX}_${this.unnegotiatedSocketCount++}`
    const dataChannel = this.pc.createDataChannel(label)
    const socket = new RTCSocket(dataChannel)
    await once(socket, &apos;__received&apos;)
    return socket
  }

  /**
   * &#xC0C1;&#xB300;&#xAC00; &#xB808;&#xC774;&#xBE14; &#xC5C6;&#xC774; &#xC0DD;&#xC131;&#xD55C; &#xC18C;&#xCF13;(unnegotiated socket)&#xC744; &#xBC1B;&#xC544;&#xC11C; &#xB0B4;&#xBCF4;&#xB0B4;&#xB294; async generator
   * @yields {Promise&lt;RTCSocket&gt;}
   */
  async * sockets () {
    for await (const dataChannel of this.unnegotiatedDataChannels.pushes()) {
      const socket = new RTCSocket(dataChannel, { received: true })
      yield socket
    }
  }

  /**
   * &#xB808;&#xC774;&#xBE14;&#xB85C; &#xC2DD;&#xBCC4;&#xB418;&#xB294; &#xC18C;&#xCF13;&#xC744; &#xC0DD;&#xC131;&#xD569;&#xB2C8;&#xB2E4;.
   * @private
   * @param {string} label &#xC18C;&#xCF13;&#xC744; &#xC2DD;&#xBCC4;&#xD558;&#xAE30; &#xC704;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;
   * @returns {Promise&lt;RTCSocket&gt;}
   */
  async createNegotiatedSocket (label) {
    await wait(this.polite).toBeDefined()

    // polite&#xAC00; &#xCC44;&#xB110;&#xC744; &#xB9CC;&#xB4DC;&#xB294; &#xC774;&#xC720;&#xB294; &#xC5C6;&#xC74C;. &#xADF8;&#xB0E5; &#xC815;&#xD55C;&#xAC70;.
    if (this.polite.get()) {
      const dataChannel = this.pc.createDataChannel(label)
      const socket = new RTCSocket(dataChannel)
      await once(socket, &apos;__received&apos;)
      return socket
    } else {
      let dataChannel
      if (this.negotiatedDataChannels.has(label)) {
        dataChannel = this.negotiatedDataChannels.get(label)
      } else {
        // start() &#xC548;&#xC5D0;&#xC11C; pc&#xC758; &apos;datachannel&apos; &#xC774;&#xBCA4;&#xD2B8; &#xBC1C;&#xC0DD;&#xC2DC; this.dataChannels&#xC5D0; &#xB808;&#xC774;&#xBE14;&#xC744; &#xD0A4;&#xB85C; RTCDataChannel&#xC744; &#xB123;&#xC5B4;&#xC90C;
        // &#xADF8;&#xB7EC;&#xBA74; &#xC544;&#xB798; promise&#xAC00; resolve&#xB428;
        dataChannel = await this.negotiatedDataChannels.wait(label).toBeDefined()
      }

      return new RTCSocket(dataChannel, { received: true })
    }
  }

  /**
   * &#xB370;&#xC774;&#xD130;&#xB97C; &#xBC1B;&#xAE30; &#xC704;&#xD55C; &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC744; &#xB9CC;&#xB4ED;&#xB2C8;&#xB2E4;. &#xC591;&#xCABD; &#xD53C;&#xC5B4; &#xBAA8;&#xB450; &#xB3D9;&#xC77C;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;&#xB85C; &#xC774; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xD638;&#xCD9C;&#xD558;&#xBA74; &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9D1;&#xB2C8;&#xB2E4;.
   * @param {string} label &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC744; &#xC2DD;&#xBCC4;&#xD558;&#xAE30; &#xC704;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;. __&#xC911;&#xBCF5;&#xC774; &#xBD88;&#xAC00;&#xB2A5;&#xD569;&#xB2C8;&#xB2E4;.__ (RTCDataChannel&#xACFC;&#xB294; &#xB2E4;&#xB985;&#xB2C8;&#xB2E4;)
   * @returns {Promise&lt;ReadableTransaction&gt;} &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9C0;&#xBA74; &#xADF8;&#xAC78; resolve&#xD558;&#xB294; promise
   */
  async readable (label) {
    const socket = await this.socket(label)
    const metadata = await once(socket, &apos;metadata&apos;)
    const transaction = new ReadableTransaction(socket, metadata)
    socket.writeEvent(&apos;__transaction-ready&apos;)
    return transaction
  }

  /**
   * &#xB370;&#xC774;&#xD130;&#xB97C; &#xBCF4;&#xB0B4;&#xAE30; &#xC704;&#xD55C; &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC744; &#xB9CC;&#xB4ED;&#xB2C8;&#xB2E4;. &#xC591;&#xCABD; &#xD53C;&#xC5B4; &#xBAA8;&#xB450; &#xB3D9;&#xC77C;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;&#xB85C; &#xC774; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xD638;&#xCD9C;&#xD558;&#xBA74; &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9D1;&#xB2C8;&#xB2E4;.
   * @param {string|undefined} [label] &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC744; &#xC2DD;&#xBCC4;&#xD558;&#xAE30; &#xC704;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;. __&#xC911;&#xBCF5;&#xC774; &#xBD88;&#xAC00;&#xB2A5;&#xD569;&#xB2C8;&#xB2E4;.__ &#xBE44;&#xC6CC;&#xB450;&#xBA74; unnegotiated transaction&#xC744; &#xC0DD;&#xC131;&#xD569;&#xB2C8;&#xB2E4;
   * @param {object} [metadata] &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC758; &#xBA54;&#xD0C0;&#xB370;&#xC774;&#xD130;. &#xC544;&#xBB34; &#xC815;&#xBCF4;&#xB098; &#xB123;&#xC744; &#xC218; &#xC788;&#xC2B5;&#xB2C8;&#xB2E4;.
   * @returns {Promise&lt;WritableTransaction&gt;} &#xD2B8;&#xB80C;&#xC81D;&#xC158;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9C0;&#xBA74; &#xADF8;&#xAC78; resolve&#xD558;&#xB294; promise
   */
  async writable (label = undefined, metadata) {
    /**
     * @type {RTCSocket}
     */
    let socket

    if (typeof label === &apos;string&apos;) {
      socket = await this.socket(label)
    } else {
      const labelOverride = `${UNNEGOTIATED_TRANSACTION_PREFIX}_${this.unnegotiatedTransactionCount++}`
      socket = await this.createUnnegotiatedSocket(labelOverride)
    }

    await Promise.all([
      once(socket, &apos;__transaction-ready&apos;),
      socket.writeEvent(&apos;metadata&apos;, metadata)
    ])
    return new WritableTransaction(socket, metadata)
  }

  async * readables () {
    for await (const dataChannel of this.unnegotiatedTransactions.pushes()) {
      const socket = new RTCSocket(dataChannel, { received: true })
      const metadata = await once(socket, &apos;metadata&apos;)
      const transaction = new ReadableTransaction(socket, metadata)
      socket.writeEvent(&apos;__transaction-ready&apos;)
      yield transaction
    }
  }

  /**
   * &#xC591;&#xBC29;&#xD5A5; &#xB370;&#xC774;&#xD130; &#xC804;&#xC1A1;&#xC744; &#xC704;&#xD55C; &#xCC44;&#xB110;&#xC744; &#xC5FD;&#xB2C8;&#xB2E4;. &#xC591;&#xCABD; &#xD53C;&#xC5B4; &#xBAA8;&#xB450; &#xB3D9;&#xC77C;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;&#xB85C; &#xC774; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xD638;&#xCD9C;&#xD558;&#xBA74; &#xCC44;&#xB110;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9D1;&#xB2C8;&#xB2E4;.
   * @param {string} label &#xCC44;&#xB110;&#xC744; &#xC2DD;&#xBCC4;&#xD558;&#xAE30; &#xC704;&#xD55C; &#xC2DD;&#xBCC4;&#xC790;. __&#xC911;&#xBCF5;&#xC774; &#xBD88;&#xAC00;&#xB2A5;&#xD569;&#xB2C8;&#xB2E4;.__ (RTCDataChannel&#xACFC;&#xB294; &#xB2E4;&#xB985;&#xB2C8;&#xB2E4;)
   * @returns {Promise&lt;Channel&gt;} &#xCC44;&#xB110;&#xC774; &#xB9CC;&#xB4E4;&#xC5B4;&#xC9C0;&#xBA74; &#xADF8;&#xAC78; resolve&#xD558;&#xB294; promise
   */
  async channel (label) {
    const socket = await this.socket(label)
    return new Channel(socket, this)
  }

  /**
   * &#xC2DC;&#xADF8;&#xB110;&#xB7EC;&#xB97C; &#xD1B5;&#xD574;&#xC11C; &#xC2DC;&#xADF8;&#xB110; &#xBA54;&#xC2DC;&#xC9C0;&#xB97C; &#xC804;&#xC1A1;&#xD569;&#xB2C8;&#xB2E4;.
   * @private
   * @param {object} msg &#xC804;&#xC1A1;&#xD560; &#xC2DC;&#xADF8;&#xB110; &#xBA54;&#xC2DC;&#xC9C0;
   */
  async sendSignal (msg) {
    await wait(this.signaler.ready).toBe(true)
    this.signaler.send(msg)
  }

  /**
   * RTCPeerConnection&#xC758; restartIce&#xB97C; &#xD638;&#xCD9C;&#xD569;&#xB2C8;&#xB2E4;. &#xC7AC;&#xC5F0;&#xACB0;&#xC744; &#xC704;&#xD574;&#xC11C;&#xB294; connect()&#xB97C; &#xC0AC;&#xC6A9;&#xD558;&#xC138;&#xC694;.
   */
  restartIce () {
    this.pc.restartIce()
    console.log(&apos;[RTCEngine]&apos;, &apos;ICE &#xC7AC;&#xC2DC;&#xC791;&#xB428;&apos;)
  }

  /**
   * &#xC5F0;&#xACB0;&#xC744; &#xB2EB;&#xC2B5;&#xB2C8;&#xB2E4;. &#xB450; &#xD53C;&#xC5B4; &#xC0AC;&#xC774;&#xC5D0; &#xD615;&#xC131;&#xB41C; &#xBAA8;&#xB4E0; &#xC5F0;&#xACB0;(&#xD2B8;&#xB80C;&#xC81D;&#xC158;, &#xCC44;&#xB110; &#xB4F1;)&#xC774; &#xB2EB;&#xD799;&#xB2C8;&#xB2E4;.
   * &#xC774; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xD638;&#xCD9C;&#xD55C; &#xD6C4; &#xC5D4;&#xC9C4;&#xC740; garbage collect&#xB420; &#xC218; &#xC788;&#xAC8C; &#xB429;&#xB2C8;&#xB2E4;.
   */
  close () {
    this.pc.close()
    this.pc = null
    this.listenerManager.clear()
    this.negotiatedDataChannels.clear()
    this.closed.set(true)
    this.connection.set(&apos;closed&apos;)
    console.log(&apos;[RTCEngine]&apos;, &apos;&#xC5F0;&#xACB0; &#xB2EB;&#xD798;&apos;)

    this.signaler.close()
  }

  /**
   * &#xC2DC;&#xADF8;&#xB110;&#xB7EC;&#xC5D0;&#xC11C; &#xC2EC;&#xAC01;&#xD55C; &#xC624;&#xB958;&#xAC00; &#xBC1C;&#xC0DD;&#xD574; &#xC5F0;&#xACB0;&#xC744; &#xACC4;&#xC18D; &#xC9C4;&#xD589;&#xD560; &#xC218; &#xC5C6;&#xB294; &#xACBD;&#xC6B0; &#xC5F0;&#xACB0;&#xC744; &#xAC15;&#xC81C;&#xB85C; &#xB2EB;&#xC2B5;&#xB2C8;&#xB2E4;.
   * @param {string} errorStr &#xC624;&#xB958; &#xBA54;&#xC2DC;&#xC9C0;.
   */
  abort (errorStr) {
    console.log(&apos;[RTCEngine]&apos;, &apos;&#xC624;&#xB958;&#xAC00; &#xBC1C;&#xC0DD;&#xD574; &#xC5F0;&#xACB0;&#xC744; &#xB2EB;&#xC74C;.&apos;)
    this.close()

    const error = new Error(errorStr)
    if (this.all.has(&apos;error&apos;)) {
      this.emit(&apos;error&apos;, error)
    } else {
      throw error
    }
  }

  /**
   * &#xC18C;&#xCF13;&#xC774; &#xC0AC;&#xC6A9;&#xD558;&#xB294; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xC758; &#xB808;&#xD3EC;&#xD2B8;&#xB97C; &#xAC00;&#xC838;&#xC635;&#xB2C8;&#xB2E4;.
   * @param {RTCSocket} socket &#xB808;&#xD3EC;&#xD2B8;&#xB97C; &#xC77D;&#xACE0; &#xC2F6;&#xC740; &#xB300;&#xC0C1; &#xC18C;&#xCF13;
   * @returns {RTCStatsReport} &#xC18C;&#xCF13;&#xC774; &#xC0AC;&#xC6A9;&#xD558;&#xB294; &#xB370;&#xC774;&#xD130; &#xCC44;&#xB110;&#xC758; &#xB808;&#xD3EC;&#xD2B8;
   */
  async getReport (socket) {
    for (const [, report] of await this.pc.getStats()) {
      if (report.type === &apos;data-channel&apos; &amp;&amp; report.dataChannelIdentifier === socket.dataChannel.id) {
        return report
      }
    }
  }

  /**
   * &#xD50C;&#xB7EC;&#xADF8;&#xC778;&#xC744; &#xC0AC;&#xC6A9;&#xD569;&#xB2C8;&#xB2E4;.
   * @param {Function} plugin &#xD50C;&#xB7EC;&#xADF8;&#xC778; &#xD568;&#xC218;. &#xCCAB;&#xBC88;&#xC9F8; &#xC778;&#xC790;&#xB85C; RTCEngine &#xD074;&#xB798;&#xC2A4;&#xAC00; &#xC804;&#xB2EC;&#xB429;&#xB2C8;&#xB2E4;. &#xD50C;&#xB7EC;&#xADF8;&#xC778; &#xD568;&#xC218;&#xB294; &#xD504;&#xB85C;&#xD1A0;&#xD0C0;&#xC785;&#xC744; &#xD1B5;&#xD574; &#xC6D0;&#xD558;&#xB294; &#xBA54;&#xC18C;&#xB4DC;&#xB97C; &#xCD94;&#xAC00;&#xD560; &#xC218; &#xC788;&#xC2B5;&#xB2C8;&#xB2E4;.
   */
  static plugin (plugin) {
    if (typeof plugin !== &apos;function&apos;) {
      throw new Error(&apos;only function-style plugin is supported&apos;)
    }

    plugin(RTCEngine)
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
